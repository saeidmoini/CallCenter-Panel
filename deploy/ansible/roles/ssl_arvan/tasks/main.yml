- name: Ensure ssl directory exists
  file:
    path: "{{ ssl_dir }}"
    state: directory
    mode: '0755'

- name: Ensure acme dnsapi directory exists
  file:
    path: "/root/.acme.sh/dnsapi"
    state: directory
    mode: '0755'

- name: Install acme.sh if missing
  when: domain is defined and domain != "" and arvan_token is defined and arvan_token != ""
  shell: |
    curl https://get.acme.sh | sh -s email={{ acme_email | default('admin@example.com') }}
  args:
    creates: "{{ acme_sh_path }}"

- name: Copy Arvan dns api script
  copy:
    src: "{{ playbook_dir }}/dns_arvan.sh"
    dest: "/root/.acme.sh/dnsapi/dns_arvan.sh"
    mode: '0755'
  when: domain is defined and domain != "" and arvan_token is defined and arvan_token != ""

- name: Reset ACME account (remove old) if requested
  file:
    path: "/root/.acme.sh/account.conf"
    state: absent
  when: domain is defined and domain != "" and arvan_token is defined and arvan_token != "" and (acme_reset_account | default(false))

- name: Register/Update ACME account (Letâ€™s Encrypt)
  when: domain is defined and domain != "" and arvan_token is defined and arvan_token != ""
  command: >
    {{ acme_sh_path }} --register-account --server letsencrypt --accountemail {{ acme_email | default('admin@example.com') }} --force
  args:
    creates: "/root/.acme.sh/account.conf"

- name: Issue Arvan wildcard cert (if domain is set)
  when: domain is defined and domain != "" and arvan_token is defined and arvan_token != ""
  environment:
    Arvan_Token: "{{ arvan_token }}"
  command: >
    {{ acme_sh_path }} --issue --server letsencrypt --accountemail {{ acme_email | default('admin@example.com') }} --dns dns_arvan
    --dnssleep 60 --debug 2
    -d {{ domain }} -d *.{{ domain }} --keylength ec-256 --ecc
  args:
    creates: "/root/.acme.sh/{{ domain }}_ecc/{{ domain }}.cer"

- name: Install Arvan cert (if issued)
  when: domain is defined and domain != "" and arvan_token is defined and arvan_token != ""
  environment:
    Arvan_Token: "{{ arvan_token }}"
  command: >
    {{ acme_sh_path }} --install-cert -d {{ domain }} --ecc
    --key-file {{ ssl_dir }}/privkey.key
    --fullchain-file {{ ssl_dir }}/fullchain.crt
    --cert-file {{ ssl_dir }}/cert.crt
    --ca-file {{ ssl_dir }}/ca.crt
    --reloadcmd "systemctl reload nginx"
  args:
    creates: "{{ ssl_dir }}/fullchain.crt"
